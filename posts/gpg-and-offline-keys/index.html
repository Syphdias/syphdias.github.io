<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>GPG and Offline Keys | relg.uk</title>
<meta name=keywords content><meta name=description content="It is time again for me to renew my GPG keys and I wanted to write something
about GnuPG/GPG and YubiKey for a while now. I want to go over some things I
think someone should know, if they want to use GPG and a YubiKey for GPG. If I
think there are good resource for learning about certain aspects, I will link to
them.
What this is not

This does not explain basics of cryptography. I assume you know about
asymmetric and symmetric encryption, and signing (basically reverse
asymmetric encryption of the contents hash). It also is not a guide on how to
use GPG on a normal day. You probably already know how to that. Take a look at
signing your git commits and using it for SSH authentication!
This does not recommend any hardware.
This does not take a look at signing git commits with SSH (though that is a
interesting topic imo).
This does not go over installation of GPG or tooling around using a smartcard
(e.g. pcscd and pcsc_scan, ykman, kdf-setup, etc.) ‚Äî maybe later.
This also does not go over thread modeling. You need to know if an
intelligence service is after you, if data corruption is a risk, etc.

Be Serious
If you are serious about using GPG, you should understand more than just how to
give your key to an application to use it to sign/(de)crypt for you. I would
recommend you never set the expiration of more than one year. Get comfortable
with generating and renewing GPG keys. Never create a non-expiring key; this
is because in case you loose access to the secret key (e.g. forgetting the
password), the key will still be invalidated eventually.
I would also recommend understanding more about the anatomy and though behind
the workings of GPG. I really liked Neal Walfield&rsquo;s Advanced Intro to GnuPG."><meta name=author content><link rel=canonical href=https://www.relg.uk/posts/gpg-and-offline-keys/><link crossorigin=anonymous href=/assets/css/stylesheet.d6fcd20a4fb86efa4dfac8ec95da60244cc8871042183da1ef28e3a762ad79c8.css integrity="sha256-1vzSCk+4bvpN+sjsldpgJEzIhxBCGD2h7yjjp2Ktecg=" rel="preload stylesheet" as=style><link rel=icon href=https://www.relg.uk/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://www.relg.uk/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://www.relg.uk/favicon-32x32.png><link rel=apple-touch-icon href=https://www.relg.uk/apple-touch-icon.png><link rel=mask-icon href=https://www.relg.uk/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://www.relg.uk/posts/gpg-and-offline-keys/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="https://www.relg.uk/posts/gpg-and-offline-keys/"><meta property="og:site_name" content="relg.uk"><meta property="og:title" content="GPG and Offline Keys"><meta property="og:description" content="It is time again for me to renew my GPG keys and I wanted to write something about GnuPG/GPG and YubiKey for a while now. I want to go over some things I think someone should know, if they want to use GPG and a YubiKey for GPG. If I think there are good resource for learning about certain aspects, I will link to them.
What this is not This does not explain basics of cryptography. I assume you know about asymmetric and symmetric encryption, and signing (basically reverse asymmetric encryption of the contents hash). It also is not a guide on how to use GPG on a normal day. You probably already know how to that. Take a look at signing your git commits and using it for SSH authentication! This does not recommend any hardware. This does not take a look at signing git commits with SSH (though that is a interesting topic imo). This does not go over installation of GPG or tooling around using a smartcard (e.g. pcscd and pcsc_scan, ykman, kdf-setup, etc.) ‚Äî maybe later. This also does not go over thread modeling. You need to know if an intelligence service is after you, if data corruption is a risk, etc. Be Serious If you are serious about using GPG, you should understand more than just how to give your key to an application to use it to sign/(de)crypt for you. I would recommend you never set the expiration of more than one year. Get comfortable with generating and renewing GPG keys. Never create a non-expiring key; this is because in case you loose access to the secret key (e.g. forgetting the password), the key will still be invalidated eventually.
I would also recommend understanding more about the anatomy and though behind the workings of GPG. I really liked Neal Walfield‚Äôs Advanced Intro to GnuPG."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-14T23:21:30+01:00"><meta property="article:modified_time" content="2025-01-14T23:21:30+01:00"><meta name=fediverse:creator content="@syphdias@social.linux.pizza"><meta name=twitter:card content="summary"><meta name=twitter:title content="GPG and Offline Keys"><meta name=twitter:description content="It is time again for me to renew my GPG keys and I wanted to write something
about GnuPG/GPG and YubiKey for a while now. I want to go over some things I
think someone should know, if they want to use GPG and a YubiKey for GPG. If I
think there are good resource for learning about certain aspects, I will link to
them.
What this is not

This does not explain basics of cryptography. I assume you know about
asymmetric and symmetric encryption, and signing (basically reverse
asymmetric encryption of the contents hash). It also is not a guide on how to
use GPG on a normal day. You probably already know how to that. Take a look at
signing your git commits and using it for SSH authentication!
This does not recommend any hardware.
This does not take a look at signing git commits with SSH (though that is a
interesting topic imo).
This does not go over installation of GPG or tooling around using a smartcard
(e.g. pcscd and pcsc_scan, ykman, kdf-setup, etc.) ‚Äî maybe later.
This also does not go over thread modeling. You need to know if an
intelligence service is after you, if data corruption is a risk, etc.

Be Serious
If you are serious about using GPG, you should understand more than just how to
give your key to an application to use it to sign/(de)crypt for you. I would
recommend you never set the expiration of more than one year. Get comfortable
with generating and renewing GPG keys. Never create a non-expiring key; this
is because in case you loose access to the secret key (e.g. forgetting the
password), the key will still be invalidated eventually.
I would also recommend understanding more about the anatomy and though behind
the workings of GPG. I really liked Neal Walfield&rsquo;s Advanced Intro to GnuPG."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.relg.uk/posts/"},{"@type":"ListItem","position":2,"name":"GPG and Offline Keys","item":"https://www.relg.uk/posts/gpg-and-offline-keys/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"GPG and Offline Keys","name":"GPG and Offline Keys","description":"It is time again for me to renew my GPG keys and I wanted to write something about GnuPG/GPG and YubiKey for a while now. I want to go over some things I think someone should know, if they want to use GPG and a YubiKey for GPG. If I think there are good resource for learning about certain aspects, I will link to them.\nWhat this is not This does not explain basics of cryptography. I assume you know about asymmetric and symmetric encryption, and signing (basically reverse asymmetric encryption of the contents hash). It also is not a guide on how to use GPG on a normal day. You probably already know how to that. Take a look at signing your git commits and using it for SSH authentication! This does not recommend any hardware. This does not take a look at signing git commits with SSH (though that is a interesting topic imo). This does not go over installation of GPG or tooling around using a smartcard (e.g. pcscd and pcsc_scan, ykman, kdf-setup, etc.) ‚Äî maybe later. This also does not go over thread modeling. You need to know if an intelligence service is after you, if data corruption is a risk, etc. Be Serious If you are serious about using GPG, you should understand more than just how to give your key to an application to use it to sign/(de)crypt for you. I would recommend you never set the expiration of more than one year. Get comfortable with generating and renewing GPG keys. Never create a non-expiring key; this is because in case you loose access to the secret key (e.g. forgetting the password), the key will still be invalidated eventually.\nI would also recommend understanding more about the anatomy and though behind the workings of GPG. I really liked Neal Walfield\u0026rsquo;s Advanced Intro to GnuPG.\n","keywords":[],"articleBody":"It is time again for me to renew my GPG keys and I wanted to write something about GnuPG/GPG and YubiKey for a while now. I want to go over some things I think someone should know, if they want to use GPG and a YubiKey for GPG. If I think there are good resource for learning about certain aspects, I will link to them.\nWhat this is not This does not explain basics of cryptography. I assume you know about asymmetric and symmetric encryption, and signing (basically reverse asymmetric encryption of the contents hash). It also is not a guide on how to use GPG on a normal day. You probably already know how to that. Take a look at signing your git commits and using it for SSH authentication! This does not recommend any hardware. This does not take a look at signing git commits with SSH (though that is a interesting topic imo). This does not go over installation of GPG or tooling around using a smartcard (e.g. pcscd and pcsc_scan, ykman, kdf-setup, etc.) ‚Äî maybe later. This also does not go over thread modeling. You need to know if an intelligence service is after you, if data corruption is a risk, etc. Be Serious If you are serious about using GPG, you should understand more than just how to give your key to an application to use it to sign/(de)crypt for you. I would recommend you never set the expiration of more than one year. Get comfortable with generating and renewing GPG keys. Never create a non-expiring key; this is because in case you loose access to the secret key (e.g. forgetting the password), the key will still be invalidated eventually.\nI would also recommend understanding more about the anatomy and though behind the workings of GPG. I really liked Neal Walfield‚Äôs Advanced Intro to GnuPG.\nPlayground If you just run a GPG command like gpg -K you usually use your ~/.gnupg/ (on Linux). To use another, temporary, and clean configuration directory you can set GNUPGHOME. You can export it like in the following or provide the --homedir argument for every call to GPG.\nexport GNUPGHOME=$(mktemp -d -t gnupg_$(date +%Y%m%d%H%M)_XXX) Actions of Keys You might guess that there are at least two actions a key can be used for: signing (a message) and encrypting a message.\nBut GPG defines two more actions: certifying and authentication\nYou can have separate keys for all four actions or you can combine sign, certify (signing keys), and authenticate (signing for SSH authentication). Signing and certifying are often combined, but I prefer to have a dedicated primary/certify key, to be able to move it off my devices. This is called ‚Äúoffline‚Äù; more on that later.\n# generating primary key, valid for 1 year, this could also be 2006-01-02 # use a secure passphrase gpg --quick-gen-key your@email.example ed25519 cert 1y # generate sub key for signing and encryption (requires primary passphrase) gpg --quick-add-key 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A ed25519 sign 1y gpg --quick-add-key 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A cv25519 encr 1y You can not now take a look a your key. The normal way or with more details:\n‚ùØ gpg -K your@email.example sec ed25519 2025-01-05 [C] [expires: 2026-01-05] 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A uid [ultimate] your@email.example ssb ed25519 2025-01-05 [S] [expires: 2026-01-05] ssb cv25519 2025-01-05 [E] [expires: 2026-01-05] There are a few things to talk about. The new key only has one uid, you can however add more, for multiple email addresses. This also shows that you trust this key ultimate-ly. Only trust your own keys to that level. But more to that later.\nThe sec shows the private primary key, ssb the private subkey.\n‚ùØ gpg -k your@email.example pub ed25519 2025-01-05 [C] [expires: 2026-01-05] 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A uid [ultimate] your@email.example sub ed25519 2025-01-05 [S] [expires: 2026-01-05] sub cv25519 2025-01-05 [E] [expires: 2026-01-05] For this key and for imported public keys you can also see pub for the primary key and sub for the public subkey.\n‚ùØ gpg --keyid-format 0xlong -K --with-subkey-fingerprint --with-keygrip your@email.example sec ed25519/0x50ED5BF8E4042B5A 2025-01-05 [C] [expires: 2026-01-05] 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A Keygrip = 2BFDFFC57B771DCE7F009C3BEF37142EBCF4B8E5 uid [ultimate] your@email.example ssb ed25519/0xB654F428066CB8A3 2025-01-05 [S] [expires: 2026-01-05] 149A02287C20580A7CF01CAAB654F428066CB8A3 Keygrip = 82887047B2E87C91CC4EA9915D22A6C4D5B23006 ssb cv25519/0x587AE7468688C837 2025-01-05 [E] [expires: 2026-01-05] 3782DF5CA1038377F172D881587AE7468688C837 Keygrip = A57B578C56165F6EFFBC1249DDE4E69F0553D433 When using your GPG key you usually reference the primary key and GPG selects the most recent subkey to do the actual work. If you have only one sub key of a kind, there cannot be any confusion, but if you have multiple subkeys you can also reference a specific subkey with SUBKEYFINGERPRINT!.\nAlso note that the 0xlong format uses the ending of the full keyid, not the start. The long version is often what you see when referring to keys.\nThe keygrip is what you will see on the file system. In ${GNUPGHOME:-$HOME/.gnupg}/private-keys-v1.d/ you can find ${keygrip}.key.\nList Packets GPG was designed to process messages in one pass and not require loading the entire messages into memory. It works on streams of packages in a specific order. This means, if you want decrypt something, the information about which key needs to be used comes first.\nMessage Looking at a simple message (a new line), encrypting it to our newly created key, and then inspecting its packets.\n‚ùØ echo |gpg -aer 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --list-packets gpg: encrypted with cv25519 key, ID 587AE7468688C837, created 2025-01-05 \"your@email.example\" # off=0 ctb=84 tag=1 hlen=2 plen=94 :pubkey enc packet: version 3, algo 18, keyid 587AE7468688C837 data: [263 bits] data: [392 bits] # off=96 ctb=d4 tag=20 hlen=2 plen=70 new-ctb :aead encrypted packet: cipher=9 aead=2 cb=16 length: 70 # off=117 ctb=a3 tag=8 hlen=1 plen=0 indeterminate :compressed packet: algo=2 # off=119 ctb=cb tag=11 hlen=2 plen=7 new-ctb :literal data packet: mode b (62), created 1736115332, name=\"\", raw data: 1 bytes The first two lines are printed to stderr and show information about the encrypted message. Then there follow four packets.\nThe first one is information about the public key used ‚Äî note that the keyid is not the primary key but the id of the subkey for encryption. The second one is a asymmetrically encrypted packet containing the symmetric session key to decrypt the message. If you ‚Äúasymmetrically‚Äù encrypt a message to multiple recipients, all it does is encrypt the symmetric key multipel times. This way the message does not have to be duplicated.\nThere is debate about if you should use AEAD due to a split between GnuPG and the OpenPGP specification it is based on. TL;DR: disable it for now. Side note: Should you ever be forced to to decrypt data encrypted to you, you should never give up your entire secret key, but only decrypt relevant session keys. This way your key is not compromised. The third packets contains the fourth packet, as far as I know. I am not an expert on GPG but as far as I understood it, there is a hierarchy to packets, but I could not find an easy way to show that. The fourth packet is the actual encrypted data that can be decrypted with the decrypted symmetric key from earlier. Note: Also try the command from above with -vv.\nNow try the same with echo | gpg -s | gpg --list-packets. You will three packets: onepass_sig, literal data, and signature.\nThe onepass_sig packet is useful for checking the signature in one pass. This way the hash for for the signature can be calculated while the message is already in memory.\nKey You can do the same on public and secret keys.\n‚ùØ gpg --export your@email.example -a |gpg --list-packets # off=0 ctb=98 tag=6 hlen=2 plen=51 :public key packet: version 4, algo 22, created 1736114781, expires 0 pkey[0]: [80 bits] ed25519 (1.3.6.1.4.1.11591.15.1) pkey[1]: [263 bits] keyid: 50ED5BF8E4042B5A # off=53 ctb=b4 tag=13 hlen=2 plen=18 :user ID packet: \"your@email.example\" # off=73 ctb=88 tag=2 hlen=2 plen=153 :signature packet: algo 22, keyid 50ED5BF8E4042B5A version 4, created 1736114781, md5len 0, sigclass 0x13 digest algo 10, begin of digest 13 2e hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A) hashed subpkt 2 len 4 (sig created 2025-01-05) hashed subpkt 27 len 1 (key flags: 01) hashed subpkt 9 len 4 (key expires after 1y0d0h0m) hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2) hashed subpkt 34 len 1 (pref-aead-algos: 2) hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2) hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1) hashed subpkt 30 len 1 (features: 07) hashed subpkt 23 len 1 (keyserver preferences: 80) subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A) data: [254 bits] data: [256 bits] # off=228 ctb=b8 tag=14 hlen=2 plen=51 :public sub key packet: version 4, algo 22, created 1736114906, expires 0 pkey[0]: [80 bits] ed25519 (1.3.6.1.4.1.11591.15.1) pkey[1]: [263 bits] keyid: B654F428066CB8A3 # off=281 ctb=88 tag=2 hlen=2 plen=245 :signature packet: algo 22, keyid 50ED5BF8E4042B5A version 4, created 1736114906, md5len 0, sigclass 0x18 digest algo 10, begin of digest 50 5d hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A) hashed subpkt 2 len 4 (sig created 2025-01-05) hashed subpkt 27 len 1 (key flags: 02) hashed subpkt 9 len 4 (key expires after 1y0d0h0m) subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A) subpkt 32 len 117 (signature: v4, class 0x19, algo 22, digest algo 10) data: [256 bits] data: [255 bits] # off=528 ctb=b8 tag=14 hlen=2 plen=56 :public sub key packet: version 4, algo 18, created 1736114910, expires 0 pkey[0]: [88 bits] cv25519 (1.3.6.1.4.1.3029.1.5.1) pkey[1]: [263 bits] pkey[2]: [32 bits] keyid: 587AE7468688C837 # off=586 ctb=88 tag=2 hlen=2 plen=126 :signature packet: algo 22, keyid 50ED5BF8E4042B5A version 4, created 1736114910, md5len 0, sigclass 0x18 digest algo 10, begin of digest 73 9c hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A) hashed subpkt 2 len 4 (sig created 2025-01-05) hashed subpkt 27 len 1 (key flags: 0C) hashed subpkt 9 len 4 (key expires after 1y0d0h0m) subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A) data: [256 bits] data: [256 bits] The first packet is the public or secret key (depending on what you looked at). You might spot expires 0. This means no expiration but will be overwritten later. The second packet is the user id. The third packet is probably the most interesting packet as it is the signature of the two earlier packets and contains the settings for the key, like preferred algorithms and the expiration. This is the reason why you can easily change the expiration on a key without invalidating the key or invalidating signatures of the key and uid: The key stays the same, only the signature changes. Every uid get its own signature, so it can be easily removed. Then the two subkeys follow, first the public/secret key itself,‚Ä¶ ‚Ä¶then the signature from the primary key that also tells others that these are subkeys of the primary key and other settings. This means, that to change expiration of the subkeys, you need the primary key. These keys are not special to the primary key. In fact, it is possible to reuse the same same subkeys and recertify them to another primary key (should you have lost the old one). There is also other black magic you can do. Signing keys also cross-sign the primary key to prevent someone pretending that the subkey is theirs. Offline Keys and a YubiKey Generally offline key only means, that it is currently not on the device. It could be on another computer, on a flash drive, or a smart card like a YubiKey. It is generally recommended to use an offline primary key, but any key could be offline.\nHaving an offline primary key comes with some caveats. While you can use all other keys normally, you cannot create, revoke, sign other keys, or change subkeys or uids. This includes settings, e.g. expiration.\nIt is important to understand that a smartcard or a YubiKey with smartcard functionality a key only goes one way. You can store a key on a smartcard/YK but you can never retrieve it (in lieu of exploits). This is very much intentional, as the idea of smartcards is to do the secure computing on the card and never load any secrets into comptuer memory. This is by design how it is supposed to work.\nThis is why you need to watch out for the command addtocard which saves the key to the smartcard and deletes the key from disk. Meaning you can never backup that key again, if you do not have a backup already. The same applies if you generate the key on the smartcard ‚Äî your computer will never see the contents of that key.\nAnother limitation of my YubiKey is, that it only has three key slots. One for a signature key, one for an encryption key, one for an authentication key. So if you use separate keys for certify and sign, you are SOL because you can only put one into the signing slot. In my case I put the primary key into the signature slot as an additional backup and to be able to manage subkeys more easily without needing to go to the true offline primary key.\nIf you see sec#, the primary key is not on the device. If you see sec\u003e the primary key is on a smartcard (if you look at the keygrip file you will find a stub instead of the actual key).\nBackup and Removal of Key There is something more important than backing up your encrypted email ‚Äî backing up your secret keys. The easiest way is to just backup the entire GNUPGHOME, usually ~/.gnupg/. In my case I have LUKS encrypted flash drive I copy it to. All usual backup practices apply ‚Äî 3-2-1, in case your house gets struck by lightning while the flash drive is inserted into your computer.\nDATE=$(date +%F) mkdir /run/media/syphdias/LUKS001/gpg/.gnupg-$DATE rsync -aP ~/.gnupg/ /run/media/syphdias/LUKS001/gpg/.gnupg-$DATE I use the date, in case I mess something up, during renewal. Now we remove the primary key from our keyring on the device. We already found the keygrip when looking at our keys.\n‚ùØ rm ~/.gnupg/private-keys-v1.d/2BFDFFC57B771DCE7F009C3BEF37142EBCF4B8E5.key ‚ùØ GNUPGHOME=gnupg_202501051540_gqK/ gpg -K /home/syphdias/.gnupg/pubring.kbx -------------------------------------------------------------------------------- sec# ed25519 2025-01-05 [C] [expires: 2026-01-05] 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A uid [ultimate] your@email.example ssb ed25519 2025-01-05 [S] [expires: 2026-01-05] ssb cv25519 2025-01-05 [E] [expires: 2026-01-05] Seeing sec# shows the successful removal of the primary key. Keep in mind the caveats from above.\nRenewing with Offline Key A year has passed and you are still into GPG for some nerdish reason and want to keep working with out keys without regenerating completely new ones.\n‚ùØ cd /run/media/syphdias/LUKS001/gpg/ ‚ùØ cp -r .gnupg-2024-01-10/ .gnupg-2025-01-14/ ‚ùØ # only work on a copy of your backup for safety ‚ùØ gpg --quick-set-expire usage: gpg [options] --quick-set-exipre FINGERPRINT EXPIRE [SUBKEY-FPRS] ‚ùØ # renew primary key ‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --quick-set-expire 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A 2027-01-05 ‚ùØ # renew subkeys ‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --quick-set-expire 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A 2027-01-05 149A02287C20580A7CF01CAAB654F428066CB8A3 3782DF5CA1038377F172D881587AE7468688C837 You can use GNUPGHOME=.gnupg-2025-01-14 gpg -K this worked. If you wanted you could also change other attributes at this time, like preferred algorithms, or add another uid. If we are happy with the keyring, you can keep the directory as backup to copy for next year.\nThere are a few ways how you could get the renewed offline keys to your machine(s) now. You could copy the subkeys by keygrip ‚Äî dont! Or copy over the entire keyring and remove the primary key again ‚Äî meh! The proper way is to export the secret subkeys only and import them into your current keyring.\n‚ùØ # check if you will import what you wanted ‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --export-secret-subkeys --export-options export-minimal 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --import --import-options show-only ‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --export-secret-subkeys --export-options export-minimal 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --import ‚ùØ # if you published your GPG key, update the published key ‚ùØ gpg --send-keys 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A You could only export certain subkeys, if you wanted. Or, if you have multiple uids, you could also filter your export with --export-filter keep-ui=mbox=your@email.example. To check your export you can check the import without importing by using the command gpg --import --import-opstions show-only. This can also be useful for others‚Äô public keys.\nEvery time you change settings of your GPG key, you create a new signature. With --export-optitons export-minimal removes all signatures except the most recent one.\nMoving Key to YubiKey If you want to have your primary key not just in your backup, you can edit your key (gpg --edit-key KEY) and select keytocard. Leave with save. From then on you can use the key on the YubiKey. Keep in mind that there are only three key slots. I mainly have this a additional backup of my primary key and to be able to use the primary key to manage subkeys that I might not need in my backup and to set settings on-the-fly without requiring my true offline primary key.\nPublishing to a Keyserver Keyservers were very open in the past. You just uploaded your key to them and there were forever findable and others could upload their signatures for other keys, etc. This is kinda dead. For one you could DOS someone with overwhelming their key with signature. This was basically the last nail in the coffin for the Web of Trust. Another reason the traditional keyservers are no longer around is the GDPR which requires the option to remove personal identifiable data on request. Today you can either publish your GPG in a place you think proper for people to manually find it, use Web Key Directory (WKD) to store keys on your website at /.well-known/openpgpkey/hu/hash-of-uid, or upload your key to https://keys.openpgp.org where you will also need to verify your email address.\nMisc In the past GPG wanted key owners verifying each other‚Äôs keys and establish a ‚ÄúWeb of Trust‚Äù in key signing parties. This did not take hold and is basically nerd sports for enthusiasts that do it for the fun of it. The practical application is basically dead. Trust on first use (TOFU) is easier in practice with less overhead. You can combine the two modes by setting trust-model tofu+pgp in your ${GNUPGHOME:-$HOME/.gnupg}/gpg.conf.\nYubiKeys has more uses than acting as a smartcard for GPG.\n‚ùØ ykman --device 12345678 info WARNING: PC/SC not available. Smart card (CCID) protocols will not function. ERROR: Unable to list devices for connection Device type: YubiKey 5C NFC Serial number: 12345678 Firmware version: 5.4.3 Form factor: Keychain (USB-C) Enabled USB interfaces: OTP, FIDO, CCID NFC transport is enabled Applications USB NFC Yubico OTP Enabled Enabled FIDO U2F Enabled Enabled FIDO2 Enabled Enabled OATH Enabled Enabled PIV Enabled Enabled OpenPGP Enabled Enabled YubiHSM Auth Enabled Enabled Settings There are a few settings I think you should take a look at in the ~/.gnupg/gpg.conf file.\n# If you do not set this option the first secret key found will be used default-key YOURKEYID # If you encrypt someone, you will never again be able to decrypt it. This can # be a feature to be anonymous, but can be a pain, if you use this to send # emails and still want to be able to read your sent emails. default-recipient-self # disable comments in clear text signatures and ASCII armored messages no-comments # default to long format keyid-format 0xlong # try GPG agent before asking for passphrase use-agent # use TOFU and WOT/PGP trust-model tofu+pgp # used for --(recv|send|search)-keys keyserver hkps://keys.openpgp.org:443/ I will not include any cipher preferences as they will go out of date.\nBest-ish Practices ‚Ä¶as far as I can tell.\nuse secure passphrases reference key by long format (opposed to short id or email) again, always set expiration for all keys create revoke file for your primary key gpg --gen-revoke KEY do not use comment field maybe use name field ‚Äî peoples opinions vary Further Reading There is probably more that I want to write but at some point it just has to be another day, another post.\nI can recommend drduh‚Äôs YubiKey-Guide. If you want to use a YubiKey at least give it a skim. And if you got your YubiKey, read it whole.\n","wordCount":"3298","inLanguage":"en","datePublished":"2025-01-14T23:21:30+01:00","dateModified":"2025-01-14T23:21:30+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.relg.uk/posts/gpg-and-offline-keys/"},"publisher":{"@type":"Organization","name":"relg.uk","logo":{"@type":"ImageObject","url":"https://www.relg.uk/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.relg.uk/ accesskey=h title="relg.uk (Alt + H)">relg.uk</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://www.relg.uk/de/ title=üá©üá™ aria-label=:de:>De</a></li></ul></div></div><ul id=menu><li><a href=https://www.relg.uk/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li><li><a href=https://www.relg.uk/archives/ title=archive><span>archive</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">GPG and Offline Keys</h1><div class=post-meta><span title='2025-01-14 23:21:30 +0100 +0100'>2025-01-14</span>&nbsp;¬∑&nbsp;16 min&nbsp;|&nbsp;<a href=https://github.com/syphdias/syphdias.github.io/edit/main/content/posts/gpg-and-offline-keys.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>It is time again for me to renew my GPG keys and I wanted to write something
about GnuPG/GPG and YubiKey for a while now. I want to go over some things I
think someone should know, if they want to use GPG and a YubiKey for GPG. If I
think there are good resource for learning about certain aspects, I will link to
them.</p><h2 id=what-this-is-not>What this is not<a hidden class=anchor aria-hidden=true href=#what-this-is-not>#</a></h2><ul><li>This does not explain basics of cryptography. I assume you know about
asymmetric and symmetric encryption, and signing (basically <a href=https://blog.koehntopp.info/2018/03/04/hashes-in-structures.html>reverse
asymmetric encryption of the contents hash</a>). It also is not a guide on how to
use GPG on a normal day. You probably already know how to that. Take a look at
signing your git commits and using it for SSH authentication!</li><li>This does not recommend any hardware.</li><li>This does not take a look at signing git commits with SSH (though that is a
interesting topic imo).</li><li>This does not go over installation of GPG or tooling around using a smartcard
(e.g. <code>pcscd</code> and <code>pcsc_scan</code>, <code>ykman</code>, <code>kdf-setup</code>, etc.) ‚Äî maybe later.</li><li>This also does not go over thread modeling. You need to know if an
intelligence service is after you, if data corruption is a risk, etc.</li></ul><h2 id=be-serious>Be Serious<a hidden class=anchor aria-hidden=true href=#be-serious>#</a></h2><p>If you are serious about using GPG, you should understand more than just how to
give your key to an application to use it to sign/(de)crypt for you. I would
recommend you never set the expiration of more than one year. Get comfortable
with generating and renewing GPG keys. <em>Never</em> create a non-expiring key; this
is because in case you loose access to the secret key (e.g. forgetting the
password), the key will still be invalidated eventually.<br>I would also recommend understanding more about the anatomy and though behind
the workings of GPG. I really liked Neal Walfield&rsquo;s <a href=https://begriffs.com/posts/2016-11-05-advanced-intro-gnupg.html>Advanced Intro to GnuPG</a>.</p><h2 id=playground>Playground<a hidden class=anchor aria-hidden=true href=#playground>#</a></h2><p>If you just run a GPG command like <code>gpg -K</code> you usually use your <code>~/.gnupg/</code> (on
Linux). To use another, temporary, and clean configuration directory you can set
<code>GNUPGHOME</code>. You can export it like in the following or provide the <code>--homedir</code>
argument for every call to GPG.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>export GNUPGHOME<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>mktemp -d -t gnupg_<span style=color:#66d9ef>$(</span>date +%Y%m%d%H%M<span style=color:#66d9ef>)</span>_XXX<span style=color:#66d9ef>)</span>
</span></span></code></pre></div><h2 id=actions-of-keys>Actions of Keys<a hidden class=anchor aria-hidden=true href=#actions-of-keys>#</a></h2><p>You might guess that there are at least two actions a key can be used for:
signing (a message) and encrypting a message.<br>But GPG defines two more actions: certifying and authentication<br>You can have separate keys for all four actions or you can combine sign, certify
(signing keys), and authenticate (signing for SSH authentication). Signing and
certifying are often combined, but I prefer to have a dedicated primary/certify
key, to be able to move it off my devices. This is called &ldquo;offline&rdquo;; more on
that later.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># generating primary key, valid for 1 year, this could also be 2006-01-02</span>
</span></span><span style=display:flex><span><span style=color:#75715e># use a secure passphrase</span>
</span></span><span style=display:flex><span>gpg --quick-gen-key your@email.example ed25519 cert 1y
</span></span><span style=display:flex><span><span style=color:#75715e># generate sub key for signing and encryption (requires primary passphrase)</span>
</span></span><span style=display:flex><span>gpg --quick-add-key 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A ed25519 sign 1y
</span></span><span style=display:flex><span>gpg --quick-add-key 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A cv25519 encr 1y
</span></span></code></pre></div><p>You can not now take a look a your key. The normal way or with more details:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ gpg -K your@email.example
</span></span><span style=display:flex><span>sec   ed25519 2025-01-05 [C] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      8CE453902E8E810DB46B8A5550ED5BF8E4042B5A
</span></span><span style=display:flex><span>uid           [ultimate] your@email.example
</span></span><span style=display:flex><span>ssb   ed25519 2025-01-05 [S] [expires: 2026-01-05]
</span></span><span style=display:flex><span>ssb   cv25519 2025-01-05 [E] [expires: 2026-01-05]
</span></span></code></pre></div><p>There are a few things to talk about. The new key only has one <code>uid</code>, you can
however add more, for multiple email addresses. This also shows that you
trust this key ultimate-ly. Only trust your own keys to that level. But more to
that later.</p><p>The <code>sec</code> shows the private primary key, <code>ssb</code> the private subkey.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ gpg -k your@email.example
</span></span><span style=display:flex><span>pub   ed25519 2025-01-05 [C] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      8CE453902E8E810DB46B8A5550ED5BF8E4042B5A
</span></span><span style=display:flex><span>uid           [ultimate] your@email.example
</span></span><span style=display:flex><span>sub   ed25519 2025-01-05 [S] [expires: 2026-01-05]
</span></span><span style=display:flex><span>sub   cv25519 2025-01-05 [E] [expires: 2026-01-05]
</span></span></code></pre></div><p>For this key and for imported public keys you can also see <code>pub</code> for the primary
key and <code>sub</code> for the public subkey.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ gpg --keyid-format 0xlong -K --with-subkey-fingerprint --with-keygrip your@email.example
</span></span><span style=display:flex><span>sec   ed25519/0x50ED5BF8E4042B5A 2025-01-05 [C] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      8CE453902E8E810DB46B8A5550ED5BF8E4042B5A
</span></span><span style=display:flex><span>      Keygrip = 2BFDFFC57B771DCE7F009C3BEF37142EBCF4B8E5
</span></span><span style=display:flex><span>uid                   [ultimate] your@email.example
</span></span><span style=display:flex><span>ssb   ed25519/0xB654F428066CB8A3 2025-01-05 [S] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      149A02287C20580A7CF01CAAB654F428066CB8A3
</span></span><span style=display:flex><span>      Keygrip = 82887047B2E87C91CC4EA9915D22A6C4D5B23006
</span></span><span style=display:flex><span>ssb   cv25519/0x587AE7468688C837 2025-01-05 [E] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      3782DF5CA1038377F172D881587AE7468688C837
</span></span><span style=display:flex><span>      Keygrip = A57B578C56165F6EFFBC1249DDE4E69F0553D433
</span></span></code></pre></div><p>When using your GPG key you usually reference the primary key and GPG selects
the most recent subkey to do the actual work. If you have only one sub key of a
kind, there cannot be any confusion, but if you have multiple subkeys you can
also reference a specific subkey with <code>SUBKEYFINGERPRINT!</code>.<br>Also note that the <code>0xlong</code> format uses the ending of the full keyid, not the
start. The <code>long</code> version is often what you see when referring to keys.<br>The keygrip is what you will see on the file system. In
<code>${GNUPGHOME:-$HOME/.gnupg}/private-keys-v1.d/</code> you can find <code>${keygrip}.key</code>.</p><h2 id=list-packets>List Packets<a hidden class=anchor aria-hidden=true href=#list-packets>#</a></h2><p>GPG was designed to process messages in one pass and not require loading the
entire messages into memory. It works on streams of packages in a specific
order. This means, if you want decrypt something, the information about which
key needs to be used comes first.</p><h3 id=message>Message<a hidden class=anchor aria-hidden=true href=#message>#</a></h3><p>Looking at a simple message (a new line), encrypting it to our newly created
key, and then inspecting its packets.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ echo |gpg -aer 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --list-packets
</span></span><span style=display:flex><span>gpg: encrypted with cv25519 key, ID 587AE7468688C837, created 2025-01-05
</span></span><span style=display:flex><span>      &#34;your@email.example&#34;
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ctb<span style=color:#f92672>=</span><span style=color:#ae81ff>84</span> tag<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>94</span>
</span></span><span style=display:flex><span>:pubkey enc packet: version 3, algo 18, keyid 587AE7468688C837
</span></span><span style=display:flex><span>        data: [263 bits]
</span></span><span style=display:flex><span>        data: [392 bits]
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> ctb<span style=color:#f92672>=</span>d4 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>70</span> new-ctb
</span></span><span style=display:flex><span>:aead encrypted packet: cipher=9 aead=2 cb=16
</span></span><span style=display:flex><span>        length: 70
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>117</span> ctb<span style=color:#f92672>=</span>a3 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> indeterminate
</span></span><span style=display:flex><span>:compressed packet: algo=2
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>119</span> ctb<span style=color:#f92672>=</span>cb tag<span style=color:#f92672>=</span><span style=color:#ae81ff>11</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>7</span> new-ctb
</span></span><span style=display:flex><span>:literal data packet:
</span></span><span style=display:flex><span>        mode b (62), created 1736115332, name=&#34;&#34;,
</span></span><span style=display:flex><span>        raw data: 1 bytes
</span></span></code></pre></div><p>The first two lines are printed to stderr and show information about the
encrypted message. Then there follow four packets.</p><ul><li>The first one is information about the public key used ‚Äî note that the keyid
is not the primary key but the id of the subkey for encryption.</li><li>The second one is a asymmetrically encrypted packet containing the symmetric
session key to decrypt the message. If you &ldquo;asymmetrically&rdquo; encrypt a message
to multiple recipients, all it does is encrypt the symmetric key multipel
times. This way the message does not have to be duplicated.<br>There is debate about if you should use AEAD due to a split between GnuPG and
the OpenPGP specification it is based on. TL;DR: <a href=https://security.stackexchange.com/questions/275883/should-one-really-disable-aead-for-recent-gnupg-created-pgp-keys>disable it for now</a>.<ul><li>Side note: Should you ever be forced to to decrypt data encrypted to you,
you should <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">never give up</a> your entire secret key, but only decrypt relevant
session keys. This way your key is not compromised.</li></ul></li><li>The third packets contains the fourth packet, as far as I know. I am not an
expert on GPG but as far as I understood it, there is a hierarchy to packets,
but I could not find an easy way to show that.</li><li>The fourth packet is the actual encrypted data that can be decrypted with the
decrypted symmetric key from earlier.</li></ul><p>Note: Also try the command from above with <code>-vv</code>.</p><p>Now try the same with <code>echo | gpg -s | gpg --list-packets</code>. You will three
packets: onepass_sig, literal data, and signature.<br>The onepass_sig packet is useful for checking the signature in one pass. This
way the hash for for the signature can be calculated while the message is
already in memory.</p><h3 id=key>Key<a hidden class=anchor aria-hidden=true href=#key>#</a></h3><p>You can do the same on public and secret keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ gpg --export your@email.example -a |gpg --list-packets
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> ctb<span style=color:#f92672>=</span><span style=color:#ae81ff>98</span> tag<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>:public key packet:
</span></span><span style=display:flex><span>        version 4, algo 22, created 1736114781, expires 0
</span></span><span style=display:flex><span>        pkey[0]: [80 bits] ed25519 (1.3.6.1.4.1.11591.15.1)
</span></span><span style=display:flex><span>        pkey[1]: [263 bits]
</span></span><span style=display:flex><span>        keyid: 50ED5BF8E4042B5A
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>53</span> ctb<span style=color:#f92672>=</span>b4 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>:user ID packet: &#34;your@email.example&#34;
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>73</span> ctb<span style=color:#f92672>=</span><span style=color:#ae81ff>88</span> tag<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>153</span>
</span></span><span style=display:flex><span>:signature packet: algo 22, keyid 50ED5BF8E4042B5A
</span></span><span style=display:flex><span>        version 4, created 1736114781, md5len 0, sigclass 0x13
</span></span><span style=display:flex><span>        digest algo 10, begin of digest 13 2e
</span></span><span style=display:flex><span>        hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        hashed subpkt 2 len 4 (sig created 2025-01-05)
</span></span><span style=display:flex><span>        hashed subpkt 27 len 1 (key flags: 01)
</span></span><span style=display:flex><span>        hashed subpkt 9 len 4 (key expires after 1y0d0h0m)
</span></span><span style=display:flex><span>        hashed subpkt 11 len 4 (pref-sym-algos: 9 8 7 2)
</span></span><span style=display:flex><span>        hashed subpkt 34 len 1 (pref-aead-algos: 2)
</span></span><span style=display:flex><span>        hashed subpkt 21 len 5 (pref-hash-algos: 10 9 8 11 2)
</span></span><span style=display:flex><span>        hashed subpkt 22 len 3 (pref-zip-algos: 2 3 1)
</span></span><span style=display:flex><span>        hashed subpkt 30 len 1 (features: 07)
</span></span><span style=display:flex><span>        hashed subpkt 23 len 1 (keyserver preferences: 80)
</span></span><span style=display:flex><span>        subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        data: [254 bits]
</span></span><span style=display:flex><span>        data: [256 bits]
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>228</span> ctb<span style=color:#f92672>=</span>b8 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>
</span></span><span style=display:flex><span>:public sub key packet:
</span></span><span style=display:flex><span>        version 4, algo 22, created 1736114906, expires 0
</span></span><span style=display:flex><span>        pkey[0]: [80 bits] ed25519 (1.3.6.1.4.1.11591.15.1)
</span></span><span style=display:flex><span>        pkey[1]: [263 bits]
</span></span><span style=display:flex><span>        keyid: B654F428066CB8A3
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>281</span> ctb<span style=color:#f92672>=</span><span style=color:#ae81ff>88</span> tag<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>245</span>
</span></span><span style=display:flex><span>:signature packet: algo 22, keyid 50ED5BF8E4042B5A
</span></span><span style=display:flex><span>        version 4, created 1736114906, md5len 0, sigclass 0x18
</span></span><span style=display:flex><span>        digest algo 10, begin of digest 50 5d
</span></span><span style=display:flex><span>        hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        hashed subpkt 2 len 4 (sig created 2025-01-05)
</span></span><span style=display:flex><span>        hashed subpkt 27 len 1 (key flags: 02)
</span></span><span style=display:flex><span>        hashed subpkt 9 len 4 (key expires after 1y0d0h0m)
</span></span><span style=display:flex><span>        subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        subpkt 32 len 117 (signature: v4, class 0x19, algo 22, digest algo 10)
</span></span><span style=display:flex><span>        data: [256 bits]
</span></span><span style=display:flex><span>        data: [255 bits]
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>528</span> ctb<span style=color:#f92672>=</span>b8 tag<span style=color:#f92672>=</span><span style=color:#ae81ff>14</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>56</span>
</span></span><span style=display:flex><span>:public sub key packet:
</span></span><span style=display:flex><span>        version 4, algo 18, created 1736114910, expires 0
</span></span><span style=display:flex><span>        pkey[0]: [88 bits] cv25519 (1.3.6.1.4.1.3029.1.5.1)
</span></span><span style=display:flex><span>        pkey[1]: [263 bits]
</span></span><span style=display:flex><span>        pkey[2]: [32 bits]
</span></span><span style=display:flex><span>        keyid: 587AE7468688C837
</span></span><span style=display:flex><span># off<span style=color:#f92672>=</span><span style=color:#ae81ff>586</span> ctb<span style=color:#f92672>=</span><span style=color:#ae81ff>88</span> tag<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> hlen<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> plen<span style=color:#f92672>=</span><span style=color:#ae81ff>126</span>
</span></span><span style=display:flex><span>:signature packet: algo 22, keyid 50ED5BF8E4042B5A
</span></span><span style=display:flex><span>        version 4, created 1736114910, md5len 0, sigclass 0x18
</span></span><span style=display:flex><span>        digest algo 10, begin of digest 73 9c
</span></span><span style=display:flex><span>        hashed subpkt 33 len 21 (issuer fpr v4 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        hashed subpkt 2 len 4 (sig created 2025-01-05)
</span></span><span style=display:flex><span>        hashed subpkt 27 len 1 (key flags: 0C)
</span></span><span style=display:flex><span>        hashed subpkt 9 len 4 (key expires after 1y0d0h0m)
</span></span><span style=display:flex><span>        subpkt 16 len 8 (issuer key ID 50ED5BF8E4042B5A)
</span></span><span style=display:flex><span>        data: [256 bits]
</span></span><span style=display:flex><span>        data: [256 bits]
</span></span></code></pre></div><ul><li>The first packet is the public or secret key (depending on what you looked
at). You might spot <code>expires 0</code>. This means no expiration but will be
overwritten later.</li><li>The second packet is the user id.</li><li>The third packet is probably the most interesting packet as it is the
signature of the two earlier packets and contains the settings for the key,
like preferred algorithms and the expiration. This is the reason why you can
easily change the expiration on a key without invalidating the key or
invalidating signatures of the key and uid: The key stays the same, only the
signature changes. Every uid get its own signature, so it can be easily
removed.</li><li>Then the two subkeys follow, first the public/secret key itself,‚Ä¶</li><li>‚Ä¶then the signature from the primary key that also tells others that these are
subkeys of the primary key and other settings. This means, that to change
expiration of the subkeys, you need the primary key.
These keys are not special to the primary key. In fact, it is possible to
reuse the same same subkeys and recertify them to another primary key (should
you have lost the old one). There is also other black magic you can do.
Signing keys also <a href=https://www.gnupg.org/faq/subkey-cross-certify.html>cross-sign</a> the primary key to prevent someone pretending
that the subkey is theirs.</li></ul><h2 id=offline-keys-and-a-yubikey>Offline Keys and a YubiKey<a hidden class=anchor aria-hidden=true href=#offline-keys-and-a-yubikey>#</a></h2><p>Generally offline key only means, that it is currently not on the device. It
could be on another computer, on a flash drive, or a smart card like a YubiKey.
It is generally recommended to use an offline primary key, but any key could be
offline.<br>Having an offline primary key comes with some caveats. While you can use all
other keys normally, you cannot create, revoke, sign other keys, or change
subkeys or uids. This includes settings, e.g. expiration.</p><p>It is important to understand that a smartcard or a YubiKey with smartcard
functionality a key only goes one way. You can store a key on a smartcard/YK but
you can never retrieve it (in lieu of exploits). This is very much intentional,
as the idea of smartcards is to do the secure computing on the card and never
load any secrets into comptuer memory. This is by design how it is supposed to
work.<br>This is why you need to watch out for the command <code>addtocard</code> which saves the
key to the smartcard and deletes the key from disk. Meaning you can never backup
that key again, if you do not have a backup already. The same applies if you
generate the key on the smartcard ‚Äî your computer will never see the contents of
that key.</p><p>Another limitation of my YubiKey is, that it only has three key slots. One for
a signature key, one for an encryption key, one for an authentication key. So if
you use separate keys for certify and sign, you are SOL because you can only put
one into the signing slot. In my case I put the primary key into the signature
slot as an additional backup and to be able to manage subkeys more easily
without needing to go to the true offline primary key.</p><p>If you see <code>sec#</code>, the primary key is not on the device. If you see <code>sec></code> the
primary key is on a smartcard (if you look at the keygrip file you will find a
stub instead of the actual key).</p><h3 id=backup-and-removal-of-key>Backup and Removal of Key<a hidden class=anchor aria-hidden=true href=#backup-and-removal-of-key>#</a></h3><p>There is something more important than backing up your encrypted email ‚Äî backing
up your secret keys. The easiest way is to just backup the entire <code>GNUPGHOME</code>,
usually <code>~/.gnupg/</code>. In my case I have LUKS encrypted flash drive I copy it to.
All usual backup practices apply ‚Äî 3-2-1, in case your house gets struck by
lightning while the flash drive is inserted into your computer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>DATE<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +%F<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>mkdir /run/media/syphdias/LUKS001/gpg/.gnupg-$DATE
</span></span><span style=display:flex><span>rsync -aP ~/.gnupg/ /run/media/syphdias/LUKS001/gpg/.gnupg-$DATE
</span></span></code></pre></div><p>I use the date, in case I mess something up, during renewal. Now we remove the
primary key from our keyring on the device. We already found the keygrip when
looking at our keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ rm ~/.gnupg/private-keys-v1.d/2BFDFFC57B771DCE7F009C3BEF37142EBCF4B8E5.key
</span></span><span style=display:flex><span>‚ùØ GNUPGHOME=gnupg_202501051540_gqK/ gpg -K
</span></span><span style=display:flex><span>/home/syphdias/.gnupg/pubring.kbx
</span></span><span style=display:flex><span>--------------------------------------------------------------------------------
</span></span><span style=display:flex><span>sec#  ed25519 2025-01-05 [C] [expires: 2026-01-05]
</span></span><span style=display:flex><span>      8CE453902E8E810DB46B8A5550ED5BF8E4042B5A
</span></span><span style=display:flex><span>uid           [ultimate] your@email.example
</span></span><span style=display:flex><span>ssb   ed25519 2025-01-05 [S] [expires: 2026-01-05]
</span></span><span style=display:flex><span>ssb   cv25519 2025-01-05 [E] [expires: 2026-01-05]
</span></span></code></pre></div><p>Seeing <code>sec#</code> shows the successful removal of the primary key. Keep in mind the
caveats from above.</p><h3 id=renewing-with-offline-key>Renewing with Offline Key<a hidden class=anchor aria-hidden=true href=#renewing-with-offline-key>#</a></h3><p>A year has passed and you are still into GPG for some nerdish reason and want to
keep working with out keys without regenerating completely new ones.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ cd /run/media/syphdias/LUKS001/gpg/
</span></span><span style=display:flex><span>‚ùØ cp -r .gnupg-2024-01-10/ .gnupg-2025-01-14/
</span></span><span style=display:flex><span>‚ùØ # only work on a copy of your backup for safety
</span></span><span style=display:flex><span>‚ùØ gpg --quick-set-expire
</span></span><span style=display:flex><span>usage: gpg [options] --quick-set-exipre FINGERPRINT EXPIRE [SUBKEY-FPRS]
</span></span><span style=display:flex><span>‚ùØ # renew primary key
</span></span><span style=display:flex><span>‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --quick-set-expire 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A 2027-01-05
</span></span><span style=display:flex><span>‚ùØ # renew subkeys
</span></span><span style=display:flex><span>‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --quick-set-expire 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A 2027-01-05 149A02287C20580A7CF01CAAB654F428066CB8A3 3782DF5CA1038377F172D881587AE7468688C837
</span></span></code></pre></div><p>You can use <code>GNUPGHOME=.gnupg-2025-01-14 gpg -K</code> this worked. If you wanted you
could also change other attributes at this time, like preferred algorithms, or
add another uid. If we are happy with the keyring, you can keep the directory as
backup to copy for next year.</p><p>There are a few ways how you could get the renewed offline keys to your
machine(s) now. You could copy the subkeys by keygrip ‚Äî dont! Or copy over the
entire keyring and remove the primary key again ‚Äî meh! The proper way is to
export the secret subkeys only and import them into your current keyring.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ # check if you will import what you wanted
</span></span><span style=display:flex><span>‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --export-secret-subkeys --export-options export-minimal 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --import --import-options show-only
</span></span><span style=display:flex><span>‚ùØ GNUPGHOME=.gnupg-2025-01-14 gpg --export-secret-subkeys --export-options export-minimal 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A |gpg --import
</span></span><span style=display:flex><span>‚ùØ # if you published your GPG key, update the published key
</span></span><span style=display:flex><span>‚ùØ gpg --send-keys 8CE453902E8E810DB46B8A5550ED5BF8E4042B5A
</span></span></code></pre></div><p>You could only export certain subkeys, if you wanted. Or, if you have multiple
uids, you could also filter your export with <code>--export-filter keep-ui=mbox=your@email.example</code>. To check your export you can check the import
without importing by using the command <code>gpg --import --import-opstions show-only</code>. This can also be useful for others&rsquo; public keys.</p><p>Every time you change settings of your GPG key, you create a new signature. With
<code>--export-optitons export-minimal</code> removes all signatures except the most recent
one.</p><h3 id=moving-key-to-yubikey>Moving Key to YubiKey<a hidden class=anchor aria-hidden=true href=#moving-key-to-yubikey>#</a></h3><p>If you want to have your primary key not just in your backup, you can edit your
key (<code>gpg --edit-key KEY</code>) and select <code>keytocard</code>. Leave with <code>save</code>. From then
on you can use the key on the YubiKey. Keep in mind that there are only three
key slots. I mainly have this a additional backup of my primary key and to be
able to use the primary key to manage subkeys that I might not need in my backup
and to set settings on-the-fly without requiring my true offline primary key.</p><h2 id=publishing-to-a-keyserver>Publishing to a Keyserver<a hidden class=anchor aria-hidden=true href=#publishing-to-a-keyserver>#</a></h2><p>Keyservers were very open in the past. You just uploaded your key to them and
there were forever findable and others could upload their signatures for other
keys, etc. This is kinda dead. For one you could DOS someone with overwhelming
their key with signature. This was basically the last nail in the coffin for the
Web of Trust. Another reason the traditional keyservers are no longer around is
the GDPR which requires the option to remove personal identifiable data on
request. Today you can either publish your GPG in a place you think proper for
people to manually find it, use <a href=https://www.gnupg.org/blog/20160830-web-key-service.html>Web Key Directory</a> (WKD) to store keys on your
website at <code>/.well-known/openpgpkey/hu/hash-of-uid</code>, or <a href=https://keys.openpgp.org/about/usage>upload your key to
https://keys.openpgp.org</a> where you will also need to verify your email
address.</p><h2 id=misc>Misc<a hidden class=anchor aria-hidden=true href=#misc>#</a></h2><p>In the past GPG wanted key owners verifying each other&rsquo;s keys and establish a
&ldquo;Web of Trust&rdquo; in key signing parties. This did not take hold and is basically
nerd sports for enthusiasts that do it for the fun of it. The practical
application is basically dead. Trust on first use (TOFU) is easier in practice
with less overhead. You can combine the two modes by setting <code>trust-model tofu+pgp</code> in your <code>${GNUPGHOME:-$HOME/.gnupg}/gpg.conf</code>.</p><p>YubiKeys has more uses than acting as a smartcard for GPG.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-console data-lang=console><span style=display:flex><span>‚ùØ ykman --device 12345678 info
</span></span><span style=display:flex><span>WARNING: PC/SC not available. Smart card (CCID) protocols will not function.
</span></span><span style=display:flex><span>ERROR: Unable to list devices for connection
</span></span><span style=display:flex><span>Device type: YubiKey 5C NFC
</span></span><span style=display:flex><span>Serial number: 12345678
</span></span><span style=display:flex><span>Firmware version: 5.4.3
</span></span><span style=display:flex><span>Form factor: Keychain (USB-C)
</span></span><span style=display:flex><span>Enabled USB interfaces: OTP, FIDO, CCID
</span></span><span style=display:flex><span>NFC transport is enabled
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>Applications    USB     NFC
</span></span><span style=display:flex><span>Yubico OTP      Enabled Enabled
</span></span><span style=display:flex><span>FIDO U2F        Enabled Enabled
</span></span><span style=display:flex><span>FIDO2           Enabled Enabled
</span></span><span style=display:flex><span>OATH            Enabled Enabled
</span></span><span style=display:flex><span>PIV             Enabled Enabled
</span></span><span style=display:flex><span>OpenPGP         Enabled Enabled
</span></span><span style=display:flex><span>YubiHSM Auth    Enabled Enabled
</span></span></code></pre></div><h2 id=settings>Settings<a hidden class=anchor aria-hidden=true href=#settings>#</a></h2><p>There are a few settings I think you should take a look at in the
<code>~/.gnupg/gpg.conf</code> file.</p><pre tabindex=0><code class=language-conf data-lang=conf># If you do not set this option the first secret key found will be used
default-key YOURKEYID
# If you encrypt someone, you will never again be able to decrypt it. This can
# be a feature to be anonymous, but can be a pain, if you use this to send
# emails and still want to be able to read your sent emails.
default-recipient-self
# disable comments in clear text signatures and ASCII armored messages
no-comments
# default to long format
keyid-format 0xlong
# try GPG agent before asking for passphrase
use-agent
# use TOFU and WOT/PGP
trust-model tofu+pgp
# used for --(recv|send|search)-keys
keyserver hkps://keys.openpgp.org:443/
</code></pre><p>I will not include any cipher preferences as they will go out of date.</p><h2 id=best-ish-practices>Best-ish Practices<a hidden class=anchor aria-hidden=true href=#best-ish-practices>#</a></h2><p>‚Ä¶as far as I can tell.</p><ul><li>use secure passphrases</li><li>reference key by long format (opposed to short id or email)</li><li>again, <em>always</em> set expiration for all keys</li><li>create revoke file for your primary key <code>gpg --gen-revoke KEY</code></li><li><a href=http://web.archive.org/web/20201020082313/https://debian-administration.org/users/dkg/weblog/97>do not use comment field</a></li><li>maybe use name field ‚Äî peoples opinions vary</li></ul><h2 id=further-reading>Further Reading<a hidden class=anchor aria-hidden=true href=#further-reading>#</a></h2><p>There is probably more that I want to write but at some point it just has to be
another day, another post.</p><p>I can recommend drduh&rsquo;s <a href=https://github.com/drduh/YubiKey-Guide>YubiKey-Guide</a>. If you want to use a YubiKey at least
give it a skim. And if you got your YubiKey, read it whole.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://www.relg.uk/>relg.uk</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>